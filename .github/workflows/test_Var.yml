#https://scriptingchris.tech/2021/05/16/how-to-setup-a-github-actions-pipeline-for-publishing-your-powershell-module/

name: Build and Release Module
on:
  pull_request: # Only trigger the workflow if there is a pull request to the main branch
    branches: [ main ]

  workflow_dispatch: # Enables the possibility to trigger the workflow manually

  push:
      tags:
      - 'v*' # Push events to matching v*, i.e. v1.0, v20.15.10


jobs:
  # 1st Job -- Building the module
  build:
    runs-on: ubuntu-latest
    steps:
        # Check out the main branch
      - uses: actions/checkout@master

      - name: Get tag
        id: tag
        shell: pwsh
        run: |
            $ModuleName = (Get-ChildItem -Path ./Output/).Name
            $PS_Module_Version = ('v{0}' -f (Test-ModuleManifest -Path ".\$($ModuleName).psd1").Version)

            echo "MODULE_VERSION=$PS_Module_Version"  >> $Env:GITHUB_ENV
            #Add-Content -Path "$env:GITHUB_ENV" -Value "MODULE_VERSION=$ModuleVersion" -Encoding utf8
            #echo "MODULE_VERSION=$ModuleVersion" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            #write-output "MODULE_VERSION=$PS_Module_Version" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

            echo "Version ${{ env.MODULE_VERSION }}"
